<script lang="uts">
	let firstBackTime = 0

	export default {
		onLaunch() {
			console.log('App Launch')
			this.wxLogin() // å¯åŠ¨æ—¶è‡ªåŠ¨è·å–ä¸€æ¬¡ openid
		},

		onShow() {
			console.log('App Show')
		},

		onHide() {
			console.log('App Hide')
		},

		// ğŸ‘‡ åªåœ¨ APP ç«¯æ‰æœ‰çš„ç”Ÿå‘½å‘¨æœŸï¼Œç”¨æ¡ä»¶ç¼–è¯‘åŒ…èµ·æ¥
		// #ifdef APP-PLUS
		onLastPageBackPress() {
			console.log('App LastPageBackPress')
			if (firstBackTime == 0) {
				uni.showToast({
					title: 'å†æŒ‰ä¸€æ¬¡é€€å‡ºåº”ç”¨',
					position: 'bottom',
				})
				firstBackTime = Date.now()
				setTimeout(() => {
					firstBackTime = 0
				}, 2000)
			} else if (Date.now() - firstBackTime < 2000) {
				firstBackTime = Date.now()
				uni.exit()
			}
		},

		onExit() {
			console.log('App Exit')
		},
		// #endif

		methods: {
			wxLogin() {
				// å¦‚æœå·²ç»æœ‰ openidï¼Œå¯ä»¥é€‰æ‹©ä¸é‡å¤è¯·æ±‚
				const oldOpenid = uni.getStorageSync('openid') as string
				if (oldOpenid && oldOpenid.length > 0) {
					console.log('å·²æœ‰ openidï¼š', oldOpenid)
					return
				}

				uni.login({
					provider: 'weixin',
					success: (loginRes) => {
						console.log('uni.login success:', loginRes)

						if (!loginRes.code) {
							uni.showToast({
								title: 'å¾®ä¿¡ç™»å½•å¤±è´¥ï¼šæ—  code',
								icon: 'none'
							})
							return
						}

						// æŠŠ code å‘ç»™ä½ åç«¯
						uni.request({
							url: 'https://wdxwhdglzx.jzzw-tech.cn/api/wechat/openid',
							method: 'POST',
							header: {
								'content-type': 'application/json'
							},
							data: {
								code: loginRes.code
							},
							success: (res) => {
								console.log('openid æ¥å£è¿”å›:', res)

								// è¿™é‡Œçš„ç»“æ„å¯¹ä¸Šä½ åç«¯çš„è¿”å›ï¼š
								// { code: 200, data: { openid, session_key, unionid } }
								const body = res.data as UTSJSONObject

								if (body['code'] == 200) {
									const data = body['data'] as UTSJSONObject
									const openid = data['openid'] as string

									console.log('æ‹¿åˆ° openid:', openid)

									// å­˜æœ¬åœ°ï¼Œåé¢ä¸‹å•ã€ä¸ªäººä¸­å¿ƒç­‰éƒ½å¯ä»¥ç›´æ¥ç”¨
									uni.setStorageSync('openid', openid)

									uni.showToast({
										title: 'ç™»å½•æˆåŠŸ',
										icon: 'success'
									})
								} else {
									uni.showToast({
										title: 'è·å– openid å¤±è´¥:' + body['message'],
										icon: 'none'
									})
								}
							},
							fail: (err) => {
								console.log('è¯·æ±‚ openid æ¥å£å¤±è´¥:', err)
								uni.showToast({
									title: 'æœåŠ¡å™¨é”™è¯¯',
									icon: 'none'
								})
							}
						})
					},
					fail: (err) => {
						console.log('uni.login fail:', err)
						uni.showToast({
							title: 'å¾®ä¿¡ç™»å½•å¤±è´¥',
							icon: 'none'
						})
					}
				})
			}
		}
	}
</script>

<style lang="scss">
/* æ¯ä¸ªé¡µé¢å…¬å…±css */
.uni-row {
	flex-direction: row;
}

.uni-column {
	flex-direction: column;
}
</style>
