<template>
  <view class="page-container">
    <view class="bg-image-placeholder"></view>

    <view class="nav-bar">
      <view class="back-btn"><text class="back-icon">â€¹</text></view>
      <text class="nav-title">ç§¯åˆ†æŠ½å¥–</text>
      <view class="capsule-placeholder"></view>
    </view>

    <view class="title-section">
      <text class="main-title">ç§¯åˆ†æŠ½å¥–</text>
      <text class="sub-title">10ç§¯åˆ†æŠ½å¥–, å‰©ä½™ {{ remainingChances }} æ¬¡</text>
    </view>

    <view class="wheel-container">
      <view 
        class="wheel-rotate-bg" 
        :style="{ 
          transform: 'rotate(' + rotateDegree + 'deg)',
          transition: transitionConfig 
        }"
      >
        <view class="wheel-content">
          <text class="wheel-text-0">5ç§¯åˆ†</text>
          <text class="wheel-text-1">10å…ƒå¡</text>
          <text class="wheel-text-2">5ç§¯åˆ†</text>
          <text class="wheel-text-3">20ç§¯åˆ†</text>
          <text class="wheel-text-4">5ç§¯åˆ†</text>
          <text class="wheel-text-5">è°¢è°¢å‚ä¸</text>
        </view>
      </view>

      <view class="wheel-pointer"></view>

      <view class="center-btn" @click="startLottery">
        <text class="draw-text">ç«‹å³</text>
        <text class="draw-text">æŠ½å¥–</text>
      </view>
    </view>

    <view class="bottom-section">
      <view class="tab-header">
        <view class="tab-item active-tab"><text class="tab-text active-tab-text">ä»»åŠ¡</text></view>
        <view class="tab-item"><text class="tab-text inactive-tab-text">æˆ‘çš„</text></view>
      </view>
      <view class="tab-content">
        <text style="color:#999; font-size:12px; align-self:center;">å®Œæˆä»»åŠ¡è·å–æ›´å¤šç§¯åˆ†...</text>
      </view>
    </view>

    <view v-if="showModal" class="modal-mask">
      <view class="modal-content" :class="{ 'modal-animate': showModalAnimate }">
        <view class="modal-light-bg"></view>
        
        <text class="modal-title">æ­å–œè·å¾—</text>
        
        <view class="prize-box">
          <text class="prize-icon">ğŸ</text>
        </view>
        
        <text class="prize-name">{{ prizeName }}</text>
        
        <view class="modal-btn" @click="closeModal">
          <text class="modal-btn-text">å¼€å¿ƒæ”¶ä¸‹</text>
        </view>
        
        <view class="close-icon-area" @click="closeModal">
          <text class="close-x">âœ•</text>
        </view>
      </view>
    </view>

  </view>
</template>

<script setup lang="uts">
  // å®šä¹‰å¥–å“åˆ—è¡¨ (å‡è®¾é¡ºæ—¶é’ˆæ’åˆ—ï¼Œæ¯ä¸ª45åº¦)
  // ç´¢å¼•å¯¹åº”è§’åº¦ï¼š0: 0-60åº¦, 1: 60-120åº¦... è¿™é‡Œç®€å•æŒ‰6ç­‰åˆ†è®¡ç®—
  const prizes = ["5ç§¯åˆ†", "10å…ƒç¤¼å“å¡", "5ç§¯åˆ†", "20ç§¯åˆ†", "5ç§¯åˆ†", "è°¢è°¢å‚ä¸"];
  
  // çŠ¶æ€å˜é‡
  const rotateDegree = ref(0); // å½“å‰æ—‹è½¬è§’åº¦
  const transitionConfig = ref(''); // åŠ¨ç”»é…ç½®å­—ç¬¦ä¸²
  const isSpinning = ref(false); // æ˜¯å¦æ­£åœ¨æ—‹è½¬
  const remainingChances = ref(3); // å‰©ä½™æ¬¡æ•°
  
  // å¼¹çª—ç›¸å…³
  const showModal = ref(false); // é®ç½©å±‚æ˜¾ç¤º
  const showModalAnimate = ref(false); // è§¦å‘å†…å®¹åŠ¨ç”»
  const prizeName = ref("");

  // å¼€å§‹æŠ½å¥–
  const startLottery = () => {
    if (isSpinning.value) return;
    if (remainingChances.value <= 0) {
      uni.showToast({ title: "æ²¡æœ‰æœºä¼šå•¦", icon: "none" });
      return;
    }

    isSpinning.value = true;
    remainingChances.value--;

    // 1. æ¨¡æ‹Ÿéšæœºä¸­å¥–ç´¢å¼• (0-5)
    const prizeIndex = Math.floor(Math.random() * 6);
    prizeName.value = prizes[prizeIndex];

    // 2. è®¡ç®—æ—‹è½¬è§’åº¦
    // åŸºç¡€æ—‹è½¬åœˆæ•° (ä¾‹å¦‚è½¬ 6 åœˆï¼Œ360 * 6)
    const baseRounds = 360 * 6; 
    // æ¯ä¸ªå¥–é¡¹ 60åº¦ (360 / 6 = 60)
    // åŠ ä¸Šéšæœºåç§»é‡è®©æŒ‡é’ˆåœåœ¨æ‰‡åŒºä¸­é—´ (+30)
    // æ³¨æ„ï¼šæ—‹è½¬æ–¹å‘é€šå¸¸æ˜¯é¡ºæ—¶é’ˆï¼Œæ‰€ä»¥è§’åº¦æ˜¯è´Ÿæ•°æˆ–è€…ç´¯åŠ æ­£æ•°
    // è¿™é‡Œæˆ‘ä»¬ç”¨ç´¯åŠ æ­£æ•°ã€‚éœ€è¦è®¡ç®—ç›®æ ‡è§’åº¦ã€‚
    // å‡è®¾ index 0 åœ¨ 0åº¦ä½ç½®ï¼Œindex 1 åœ¨ 60åº¦...
    // ä¸ºäº†åœåœ¨ index å¤„ï¼Œæˆ‘ä»¬éœ€è¦è½¬è¿‡ (360 - index * 60) åº¦ (è§†å…·ä½“çš„è½¬ç›˜å›¾ç‰‡èµ·å§‹è§’åº¦è€Œå®š)
    // è¿™é‡Œç®€å•æ¨¡æ‹Ÿï¼šç›®æ ‡è§’åº¦ = ç´¢å¼• * 60
    const targetAngle = prizeIndex * 60; 
    
    // ç´¯åŠ ä¹‹å‰çš„è§’åº¦ï¼Œé˜²æ­¢å€’è½¬
    // æ–°çš„è§’åº¦ = å½“å‰è§’åº¦ + åŸºç¡€åœˆæ•° + (ç›®æ ‡ä½ç½® - å½“å‰ç›¸å¯¹ä½ç½®)
    // ç®€å•åšæ³•ï¼šç›´æ¥ç‹‚åŠ è§’åº¦
    const newDegree = rotateDegree.value + baseRounds + (360 - (rotateDegree.value % 360)) + (360 - targetAngle);

    // 3. å¯ç”¨ CSS è¿‡æ¸¡åŠ¨ç”» (å…ˆæ…¢åå¿«å†æ…¢: cubic-bezier)
    transitionConfig.value = "transform 4s cubic-bezier(0.25, 0.1, 0.25, 1)";
    
    // 4. æ‰§è¡Œæ—‹è½¬ (Vue ä¼šè‡ªåŠ¨æ›´æ–° DOM style)
    // å¼ºåˆ¶ä¸€ç‚¹å»¶æ—¶ç¡®ä¿ transition ç”Ÿæ•ˆ
    setTimeout(() => {
      rotateDegree.value = newDegree;
    }, 20);

    // 5. ç›‘å¬åŠ¨ç”»ç»“æŸ (4ç§’å)
    setTimeout(() => {
      isSpinning.value = false;
      // é‡ç½® transition ä»¥ä¾¿ä¸‹æ¬¡å¯ä»¥ç¬é—´é‡ç½®è§’åº¦(å¦‚æœéœ€è¦)æˆ–è€…ä¿æŒç°çŠ¶
      // è¿™é‡Œæˆ‘ä»¬ä¿æŒç°çŠ¶ï¼Œä¸‹æ¬¡ç»§ç»­ç´¯åŠ 
      
      // å¼¹å‡ºç»“æœ
      openModal();
    }, 4000); // å¿…é¡»åŒ¹é… transition-duration
  };

  const openModal = () => {
    showModal.value = true;
    // å»¶æ—¶ä¸€å°ä¼šå„¿ç»™ä¸ªè¿›åœºåŠ¨ç”»ç±»
    setTimeout(() => {
      showModalAnimate.value = true;
    }, 50);
  }

  const closeModal = () => {
    showModalAnimate.value = false;
    setTimeout(() => {
        showModal.value = false;
    }, 200);
  }
</script>

<style>
  /* --- åŸºç¡€å®¹å™¨ --- */
  .page-container {
    flex: 1;
    background-color: #a8e6cf;
    position: relative;
  }
  .bg-image-placeholder {
    position: absolute;
    top: 0; bottom: 0; left: 0; right: 0;
    background-image: linear-gradient(to bottom, #d4f5e9, #82dcb8);
  }

  /* --- å¯¼èˆªä¸æ ‡é¢˜ --- */
  .nav-bar {
    height: 44px; margin-top: 44px;
    flex-direction: row; justify-content: space-between; align-items: center; padding: 0 15px;
  }
  .back-btn {
    width: 30px; height: 30px; border-radius: 15px;
    background-color: rgba(255,255,255,0.5);
    justify-content: center; align-items: center;
  }
  .back-icon { font-size: 20px; color: #006c5b; }
  .nav-title { font-size: 18px; font-weight: bold; color: #005a4b; }
  .capsule-placeholder { width: 80px; }

  .title-section { align-items: center; margin: 20px 0; }
  .main-title { font-size: 32px; font-weight: 900; color: #fff; text-shadow: 0 2px 5px rgba(0,108,91,0.3); }
  .sub-title { font-size: 13px; color: #fff; background-color: rgba(0,108,91,0.2); padding: 4px 12px; border-radius: 12px; margin-top: 5px; }

  /* --- è½¬ç›˜æ ¸å¿ƒæ ·å¼ --- */
  .wheel-container {
    width: 300px; height: 300px;
    align-self: center;
    position: relative;
    justify-content: center; align-items: center;
    margin-bottom: 20px;
  }

  .wheel-rotate-bg {
    width: 280px; height: 280px;
    border-radius: 140px;
    background-color: #fff;
    border-width: 8px; border-color: #6cdfbf;
    /* å†…éƒ¨å¸ƒå±€ */
    position: relative;
    overflow: hidden;
  }

  /* æ¨¡æ‹Ÿæ‰‡åŒºæ–‡å­— (ç»å¯¹å®šä½) */
  .wheel-content { width: 100%; height: 100%; position: relative; }
  .wheel-text-0 { position: absolute; top: 20px; left: 120px; font-size: 12px; color: #E91E63; transform: rotate(0deg); }
  .wheel-text-1 { position: absolute; top: 60px; right: 40px; font-size: 12px; color: #FF9800; transform: rotate(60deg); }
  .wheel-text-2 { position: absolute; bottom: 60px; right: 40px; font-size: 12px; color: #E91E63; transform: rotate(120deg); }
  .wheel-text-3 { position: absolute; bottom: 20px; left: 120px; font-size: 12px; color: #2196F3; transform: rotate(180deg); }
  .wheel-text-4 { position: absolute; bottom: 60px; left: 40px; font-size: 12px; color: #E91E63; transform: rotate(240deg); }
  .wheel-text-5 { position: absolute; top: 60px; left: 40px; font-size: 12px; color: #999; transform: rotate(300deg); }

  .wheel-pointer {
    position: absolute; top: -5px; z-index: 10;
    width: 0; height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 30px solid #ff4d4f; /* çº¢è‰²å€’ä¸‰è§’æŒ‡é’ˆ */
  }

  .center-btn {
    position: absolute; z-index: 11;
    width: 70px; height: 70px; border-radius: 35px;
    background-image: linear-gradient(to bottom, #ff9c00, #ff5722);
    border: 4px solid #fff;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    justify-content: center; align-items: center;
  }
  .draw-text { color: #fff; font-weight: bold; font-size: 16px; line-height: 18px; }

  /* --- åº•éƒ¨åŒºåŸŸ --- */
  .bottom-section {
    flex: 1; background-color: #f5f5f5; border-top-left-radius: 20px; border-top-right-radius: 20px; overflow: hidden;
  }
  .tab-header { flex-direction: row; height: 50px; background-color: #006c5b; }
  .tab-item { flex: 1; justify-content: center; align-items: center; }
  .active-tab { background-color: #f5f5f5; border-top-left-radius: 20px; border-top-right-radius: 20px; }
  .tab-text { font-size: 14px; font-weight: bold; }
  .active-tab-text { color: #006c5b; }
  .inactive-tab-text { color: #fff; opacity: 0.8; }
  .tab-content { padding: 30px; }

  /* --- å¼¹çª—æ ·å¼ (Modal) --- */
  .modal-mask {
    position: absolute; top: 0; bottom: 0; left: 0; right: 0;
    background-color: rgba(0,0,0,0.6);
    justify-content: center; align-items: center;
    z-index: 999;
  }

  .modal-content {
    width: 280px;
    background-color: #fff;
    border-radius: 16px;
    padding: 20px;
    align-items: center;
    transform: scale(0.8);
    opacity: 0;
    transition-property: transform, opacity;
    transition-duration: 0.3s;
    transition-timing-function: cubic-bezier(0.175, 0.885, 0.32, 1.275); /* å¼¹æ€§æ•ˆæœ */
  }
  
  /* å¼¹çª—æ¿€æ´»æ—¶çš„æ ·å¼ç±» */
  .modal-animate {
    transform: scale(1);
    opacity: 1;
  }

  .modal-light-bg {
    position: absolute; top: -50px; left: 0; right: 0; height: 150px;
    background-image: linear-gradient(to bottom, rgba(255,215,0,0.3), rgba(255,255,255,0));
    border-top-left-radius: 16px; border-top-right-radius: 16px;
  }

  .modal-title { font-size: 20px; font-weight: bold; color: #d93025; margin-bottom: 15px; z-index: 1; }
  
  .prize-box {
    width: 100px; height: 100px; background-color: #fdf6e6; border-radius: 50%;
    justify-content: center; align-items: center; margin-bottom: 15px;
    border: 2px solid #f7d6a8;
  }
  .prize-icon { font-size: 50px; }
  
  .prize-name { font-size: 18px; color: #333; font-weight: bold; margin-bottom: 25px; }

  .modal-btn {
    width: 200px; height: 44px; background-color: #d93025; border-radius: 22px;
    justify-content: center; align-items: center; margin-bottom: 15px;
    box-shadow: 0 4px 8px rgba(217,48,37,0.3);
  }
  .modal-btn-text { color: #fff; font-size: 16px; font-weight: bold; }

  .close-icon-area { padding: 10px; }
  .close-x { font-size: 24px; color: #ccc; }

</style>