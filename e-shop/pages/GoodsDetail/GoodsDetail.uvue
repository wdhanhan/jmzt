<template>
  <!-- Â§ñÂ±ÇÂÆπÂô®ÔºöÊï¥È°µÂ∏ÉÂ±Ä -->
  <view class="page">

    <!-- È°∂ÈÉ®ÂØºËà™ÔºöÂõ∫ÂÆöÂú®È°∂ÈÉ®Ôºå‰∏çÂÜçÊîæÂà∞ scroll-view Èáå -->
    <view class="head-info">

      <!-- ÁôΩÂ∫ïÂ§¥ÈÉ®ÔºàÂêë‰∏ãÊªëÂä®Âá∫Áé∞Ôºâ -->
      <view class="head-info-white"
        :style="{
          height: (statusBarHeight+50)+'px',
          paddingTop: statusBarHeight+'px',
          opacity: pageScrollTop
        }"
      >
        <view class="back" @click="onBack">
          <image src="/static/images/icon/back_icon1.png" class="image"></image>
        </view>

        <view class="head-item">
          <view class="item" @click="onScrollView(0)">
            <text class="text" :class="{'active': headCut===0}">ÂïÜÂìÅ</text>
          </view>
          <view class="item" @click="onScrollView(1)">
            <text class="text" :class="{'active': headCut===1}">Â∫óÈì∫</text>
          </view>
          <view class="item" @click="onScrollView(2)">
            <text class="text" :class="{'active': headCut===2}">ËØÑ‰ª∑</text>
          </view>
          <view class="item" @click="onScrollView(3)">
            <text class="text" :class="{'active': headCut===3}">ËØ¶ÊÉÖ</text>
          </view>
        </view>

        <view class="operation-btn">
          <view class="btn">
            <image src="/static/images/icon/fx_icon1.png" class="image"></image>
          </view>
          <view class="btn">
            <image src="/static/images/icon/more_icon1.png" class="image"></image>
          </view>
        </view>
      </view>

      <!-- ÈÄèÊòéÂ§¥ÈÉ® -->
      <view class="head-info-transparen"
        :style="{
          height: (statusBarHeight+50)+'px',
          paddingTop: statusBarHeight+'px'
        }"
      >
        <view class="back" v-show="pageScrollTop <= 0" @click="onBack">
          <image src="/static/images/icon/back_icon2.png" class="image"></image>
        </view>

        <view class="operation-btn" v-show="pageScrollTop <= 0">
          <view class="btn">
            <image src="/static/images/icon/fx_icon2.png" class="image"></image>
          </view>
          <view class="btn">
            <image src="/static/images/icon/more_icon2.png" class="image"></image>
          </view>
        </view>
      </view>

    </view>

    <!-- ‰∏≠Èó¥ÂÜÖÂÆπÔºöscroll-view Âè™Ë¥üË¥£ÊªöÂä®ÂÜÖÂÆπ -->
    <scroll-view
      class="page-scroll"
      scroll-y="true"
      :scroll-top="scrollTop"
      @scroll="onPageScroll"
      :style="{ flex: 1 }"
    >
      <!-- ÁªôÂÜÖÂÆπÂä† paddingTop ÈÅøÂÖçË¢´ fixed ÁöÑ head-info Áõñ‰ΩèÔºå
           Âä† paddingBottom ÈÅøÂÖçË¢´Â∫ïÈÉ®Ê†èÈÅÆ‰Ωè -->
      <view
        :style="{
          paddingTop: (statusBarHeight + 50) + 'px',
          paddingBottom: '140rpx'
        }"
      >
        <!-- Banner Â§öÂõæËΩÆÊí≠ -->
        <view class="banner-info" :style="{height: screenWidth+'px'}">
          <swiper class="swiper"
            :autoplay="true"
            :circular="true"
            :indicator-dots="false"
            @change="changeBanner">

            <swiper-item 
              v-for="(img,index) in info.images" 
              :key="index"
            >
              <image :src="img" class="image" mode="aspectFill"></image>
            </swiper-item>

          </swiper>

          <view class="indicator-dot">
            <view class="dots"
              v-for="(img,index) in info.images"
              :key="index"
              :class="{'active':bannerCurrent===index}"/>
          </view>
        </view>

        <!-- ÂïÜÂìÅ‰ø°ÊÅØ -->
        <view class="goods-info">
          <view class="price-info">
            <view class="price">
              <text class="min">Ôø•</text>
              <text class="max">{{ displayPrice }}</text>
            </view>
          </view>

          <view class="goods-name">
            <view class="name">
              <text class="text">{{info.name}}</text>
            </view>
          </view>

          <view class="goods-desc">
            <text class="text">
              {{ info.description }}
            </text>
          </view>
        </view>

        <!-- ÂõæÊñáËØ¶ÊÉÖ -->
        <view class="goods-detail" ref="goodsDetail">
          <view class="title-info">
            <view class="title">
              <view class="line"></view>
              <text class="tit">ÂõæÊñá‰ø°ÊÅØ</text>
            </view>
          </view>

          <view class="content">
            <image 
              v-for="(img,index) in info.images"
              :key="index"
              :src="img"
              mode="widthFix"
              style="width:100%;margin-bottom:15rpx;"
            ></image>
          </view>
        </view>
      </view>
    </scroll-view>

    <!-- Â∫ïÈÉ®ÊåâÈíÆÔºöÁßªÂà∞ scroll-view Â§ñÔºåÁúüÊ≠£ fixedÔºåÂú® iOS ‰∏äÂ∞±ËÉΩÁ®≥ÂÆöÊòæÁ§∫ -->
    <view class="footer-info">
      <view class="footer-btn">
        <view class="btn" @click="onCallService">
          <image src="/static/images/icon/kft_icon.png" class="image"></image>
          <text class="text">Âí®ËØ¢</text>
        </view>
      </view>

      <view class="buy-info">
        <!-- ‚≠ê ËøôÈáåÁªßÁª≠Áî® openPopupÔºåÂÜÖÈÉ®Ë∞ÉÁî® $callMethod Ë∑üÊóßÁâà‰øùÊåÅ‰∏ÄËá¥ -->
        <view class="add-cart-btn" @click="openPopup('cart')">
          <text class="text">Âä†ÂÖ•Ë¥≠Áâ©ËΩ¶</text>
        </view>
        <view class="buy-btn" @click="openPopup('buy')">
          <text class="text">Á´ãÂç≥Ë¥≠‰π∞</text>
        </view>
      </view>
    </view>

    <!-- SKU ÂºπÁ™óÔºàuts ÁªÑ‰ª∂ÔºâÔºö‰πüÊîæÂú® scroll-view Â§ñÊõ¥ÂÆâÂÖ® -->
    <attr-popup ref="AttrPopup" :info="info"></attr-popup>
  </view>
</template>

<script>
import AttrPopup from './components/AttrPopup/AttrPopup'

export default {
  components: {
    AttrPopup
  },

  data() {
    return {
      statusBarHeight: 0,
      screenWidth: 0,
      bannerCurrent: 0,
      scrollTop: 0,
      pageScrollTop: 0,
      headCut: 0,
      goodsId: 0,
      info: { images: [], skus: [] },
    };
  },

  computed: {
    // ÊòæÁ§∫‰ª∑Ê†ºÔºö‰ºòÂÖàÁî®Á¨¨‰∏Ä‰∏™ SKU ÁöÑ‰ª∑Ê†ºÔºåÊ≤°ÊúâÂ∞±Áî®ÂïÜÂìÅ price
    displayPrice() {
      if (this.info.skus && this.info.skus.length > 0) {
        return this.info.skus[0].price;
      }
      return this.info.price || 0;
    }
  },

  onLoad(options) {
    const w = uni.getWindowInfo();
    this.statusBarHeight = w.statusBarHeight;
    this.screenWidth = w.screenWidth;

    this.goodsId = Number(options.goodsId || 0);
    this.getData();
  },

  methods: {
    onBack() {
      uni.navigateBack();
    },

    // ‚≠ê Êã®ÊâìÂÆ¢ÊúçÁîµËØù
    onCallService() {
      uni.makePhoneCall({
        phoneNumber: '0939-5959039',
        fail: (err) => {
          console.error('Êã®ÊâìÁîµËØùÂ§±Ë¥•Ôºö', err);
          uni.showToast({
            title: 'Êó†Ê≥ïÂèëËµ∑ÁîµËØù',
            icon: 'none'
          });
        }
      });
    },

    // ÊãâÂèñÂêéÁ´ØÂïÜÂìÅËØ¶ÊÉÖÔºà‰Ω†Ëá™Â∑±ÁöÑ Node Êé•Âè£Ôºâ
    getData() {
      uni.request({
        url: `https://wdxwhdglzx.jzzw-tech.cn/api/products/${this.goodsId}`,
        method: "GET",
        success: (res) => {
          const data = res.data.data || {};
          this.info = {
            ...data,
            images: data.images || [],
          };
        }
      });
    },

    onPageScroll(e) {
      const top = e.detail.scrollTop;
      this.pageScrollTop = Math.min(top / 100, 1);
      if (top <= 50) this.headCut = 0;
    },

    onScrollView(type) {
      this.headCut = type;
      if (type === 0) this.scrollTop = 0;
      // ÂÖ∂‰ªñ tab ÁöÑÊªöÂä®‰Ω†ÂêéÈù¢Ë¶ÅÁöÑËØùÂÜçÂä† createSelectorQuery
    },

    changeBanner(e) {
      this.bannerCurrent = e.detail.current;
    },

    /** üî• ÂºπËµ∑ SKU ÁªÑ‰ª∂ */
    openPopup(type) {
      if (this.$refs.AttrPopup && this.$refs.AttrPopup.$callMethod) {
        this.$refs.AttrPopup.$callMethod('open', type);
      } else {
        console.warn('AttrPopup ÂÆû‰æã‰∏äÊ≤°Êúâ $callMethodÔºåÊ£ÄÊü• AttrPopup ÊòØÂê¶‰∏∫ uvue / uts ÁªÑ‰ª∂');
      }
    },

    onToShop() {
      uni.showToast({ title: "ÊöÇÊú™ÂÆûÁé∞", icon: "none" });
    }
  },
};
</script>

<style lang="scss">
  @import "GoodsDetail.scss";
</style>
