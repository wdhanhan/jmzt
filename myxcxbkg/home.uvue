<template>
  <view class="page-container">
    <swiper class="bg-swiper" :indicator-dots="false" :autoplay="true" :interval="3000" :duration="1000" :circular="true">
      <swiper-item v-for="(img, index) in bgImages" :key="index">
        <image :src="img" class="bg-image" mode="aspectFill"></image>
      </swiper-item>
    </swiper>
    
    <view class="bg-mask"></view>

    <view class="status-bar-placeholder"></view>

    <scroll-view class="main-scroll" direction="vertical" :show-scrollbar="false">
      
      <view class="hero-section">
        <view class="hero-text-group" @click="onJump('/pages/card/detail')">
          <view class="hero-title-row">
            <text class="hero-big-num">9.9</text>
            <text class="hero-small-unit">å…ƒ</text>
          </view>
          <text class="hero-sub-title">é¥ºå‹å¡</text>
          <view class="hero-tag">
            <text class="hero-tag-text">å¤©å¤©æœ€é«˜çœ40å…ƒ</text>
          </view>
          
          <view class="rotate-tag">
             <text class="rotate-tag-text">30å¤©</text>
          </view>
        </view>

<!--        <view class="center-slogan">
          <text class="slogan-text">æœ€å¿«</text>
          <text class="slogan-text">ä¸€å•å›æœ¬</text>
        </view> -->

        <view class="float-packet" @click="onJump('/pages/activity/newuser')">
          <text class="packet-text">é¢†20å…ƒ</text>
          <text class="packet-sub">æ–°äººåˆ¸åŒ…</text>
        </view>
      </view>

      <view class="core-card">
        <view class="user-row" @click="onJump('/pages/user/profile')">
          <view class="user-left">
            <view class="avatar-circle">
              <text class="avatar-icon">â˜ï¸</text>
            </view>
            <text class="user-name">Hi é¥ºå‹</text>
          </view>
          <view class="user-right">
            <text class="user-stat">ä½™é¢ {{ userInfo.balance || 0 }}</text>
            <text class="user-stat">ç§¯åˆ† {{ userInfo.points || 0 }}</text>
            <text v-if="userInfo.is_vip_valid" class="user-stat vip-badge">VIP{{ userInfo.vip_level }}</text>
            <text class="qr-mini-icon">ğŸ</text>
          </view>
        </view>

        <view class="big-actions">
          <view class="action-box" @click="onJump('/pages/classify/classify')">
            <text class="action-sub">åœ¨çº¿ç‚¹é¤ä¸ç”¨ç­‰</text>
            <view class="action-main">
              <text class="action-title">ç‚¹é¤</text>
              <text class="action-icon">ğŸ²</text>
            </view>
          </view>
          <view class="action-box" @click="onJump('/pages/welfare/index')">
            <text class="action-sub">å¥‰ä¸Šä¸€æ‰‹ä¼˜æƒ </text>
            <view class="action-main">
              <text class="action-title">ç¦åˆ©</text>
              <text class="action-icon">ğŸ«</text>
            </view>
            <view class="badge-tag">
              <text class="badge-text">æœ€æ–°æ´»åŠ¨</text>
            </view>
          </view>
        </view>

        <view class="sub-actions">
          <view class="sub-item" @click="onJump('/pages/card/month')">
            <text class="sub-icon-cloud">â˜ï¸</text>
            <text class="sub-title">è¶…å€¼æœˆå¡</text>
            <text class="sub-desc">æœ€é«˜å¯çœ1200å…ƒ</text>
          </view>
          <view class="sub-item" @click="onJump('/pages/member/rights')">
            <text class="sub-icon-cloud">â˜ï¸</text>
            <text class="sub-title">æƒç›Šå‡çº§</text>
            <text class="sub-desc">ä¼šå‘˜6å¤§ä¸“å±æƒç›Š</text>
          </view>
          <view class="sub-item" @click="onJump('/pages/gift/card')">
            <text class="sub-icon-cloud">â˜ï¸</text>
            <text class="sub-title">è¢ç¤¼å¡</text>
            <text class="sub-desc">é€TAå¿ƒæ„</text>
          </view>
        </view>
      </view>

      <view class="red-section">
        
        <view class="banner-row">
          <view class="banner-item black-gold" @click="onJump('/pages/vip/vip')">
            <text class="vip-text">VIP</text>
            <text class="vip-sub">å®šåˆ¶ç¤¼å“å¡</text>
          </view>
          <view class="banner-item red-gold" @click="onJump('/pages/member/welfare')">
            <text class="member-title">ä¼šå‘˜ç¦åˆ©å‡çº§</text>
            <view class="packet-img-placeholder">
              <text class="packet-text-sm">é¢†20å…ƒ</text>
            </view>
          </view>
        </view>

        <view class="info-card" @click="onJump('/pages/news/food')">
          <view class="info-text-area">
            <text class="info-title">çˆ†å“èµ„è®¯</text>
            <text class="info-sub">ä¸çŸ¥é“ä»Šå¤©åƒä»€ä¹ˆ?</text>
            <view class="info-btn">
              <text class="info-btn-text">ç‚¹å‡»æŸ¥çœ‹</text>
            </view>
          </view>
          <view class="info-img-area">
             <text class="food-emoji">ğŸ¥Ÿ</text>
          </view>
        </view>

        <view class="info-card" @click="onJump('/pages/brandnews/brandnews')">
          <view class="info-text-area">
            <text class="info-title">å“ç‰Œèµ„è®¯</text>
            <view class="info-btn">
              <text class="info-btn-text">ç‚¹å‡»æŸ¥çœ‹</text>
            </view>
          </view>
          <view class="info-img-area">
             <text class="food-emoji">ğŸ–ï¸ğŸ¥©</text>
          </view>
        </view>

        <view style="height: 100px;"></view>
      </view>
    </scroll-view>

  </view>
</template>

<script setup lang="uts">
  // åŸºç¡€é…ç½®
  const API_BASE = 'https://jmzt.cxxyonline.cn'

  // èƒŒæ™¯å›¾ç‰‡æ•°ç»„
  const bgImages = ref([
    '/static/images/home-pic-1.avif',
    '/static/images/home-pic-2.avif'
  ])

  // ç”¨æˆ·ä¿¡æ¯
  const userInfo = ref({
    balance: 0,
    points: 0,
    vip_level: 0,
    vip_type: 'none',
    is_vip_valid: false
  })

  /**
   * åŠ è½½ç”¨æˆ·VIPä¿¡æ¯
   */
  const loadUserVipInfo = () => {
    const openid = uni.getStorageSync('openid')
    if (!openid) {
      console.log('æœªè·å–åˆ° openidï¼Œè·³è¿‡VIPä¿¡æ¯åŠ è½½')
      return
    }

    uni.request({
      url: `${API_BASE}/api/user/vip`,
      method: 'GET',
      data: {
        openid: openid
      },
      success: (res: any) => {
        if (res.statusCode === 200 && res.data.code === 200) {
          userInfo.value = res.data.data
          console.log('ç”¨æˆ·VIPä¿¡æ¯åŠ è½½æˆåŠŸ:', userInfo.value)
        } else {
          console.warn('è·å–VIPä¿¡æ¯å¤±è´¥:', res.data?.msg)
        }
      },
      fail: (err) => {
        console.error('è·å–VIPä¿¡æ¯è¯·æ±‚å¤±è´¥:', err)
      }
    })
  }

  // é¡µé¢åŠ è½½æ—¶è·å–ç”¨æˆ·VIPä¿¡æ¯
  onLoad(() => {
    loadUserVipInfo()
  })

  // é¡µé¢æ˜¾ç¤ºæ—¶åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
  onShow(() => {
    loadUserVipInfo()
  })

  // é€šç”¨è·³è½¬äº‹ä»¶
  const onJump = (url : string) => {
    console.log(`[Router] å¯åŠ¨è·³è½¬åè®®ï¼Œç›®æ ‡è·¯å¾„: ${url}`);

    uni.navigateTo({
      url: url,
      fail: (err) => {
        // å¦‚æœæŠ¥é”™æç¤ºæ˜¯ Tabbar é¡µé¢ï¼Œæ‰§è¡Œ switchTab
        if (err.errMsg.includes("tabbar")) {
          console.log('[Router] å‘½ä¸­æ ¹è·¯ç”±ï¼Œæ‰§è¡Œ switchTab');
          uni.switchTab({ url: url });
        } else {
          // å…¶ä»–é”™è¯¯ï¼ˆå¦‚è·¯å¾„å†™é”™äº†ï¼‰è¿›è¡Œå¼¹çª—æŠ¥é”™
          uni.showToast({
            title: 'é“¾è·¯å¼‚å¸¸: ' + url,
            icon: 'none'
          });
          console.error('[Router] è·³è½¬å½»åº•å¤±è´¥:', err);
        }
      }
    });
  }

  const smartNavigate = (url : string) => {
    console.log(`[Router] å°è¯•è¿æ¥åˆ°è·¯å¾„: ${url}`);
  
    uni.navigateTo({
      url: url,
      fail: (err) => {
        // é”™è¯¯å®¡è®¡ï¼šå¦‚æœæ˜¯ tabbar é¡µé¢æŠ¥é”™ï¼Œåˆ™æ‰§è¡Œåè®®å‡çº§
        if (err.errMsg.includes("can not navigateTo a tabbar page")) {
          console.warn(`[Router] æ£€æµ‹åˆ°ç›®æ ‡ä¸º Tabbar èŠ‚ç‚¹ï¼Œåˆ‡æ¢è‡³ switchTab æ¨¡å¼`);
          uni.switchTab({
            url: url,
            success: () => {
               console.log(`[Router] Tabbar æ¡æ‰‹æˆåŠŸ`);
            },
            fail: (switchErr) => {
               console.error(`[Router] ç‰©ç†é“¾è·¯æ–­å¼€: è·¯å¾„ä¸å­˜åœ¨æˆ–é…ç½®é”™è¯¯`, switchErr);
            }
          });
        } else {
          console.error(`[Router] ç³»ç»Ÿæ€§è·³è½¬å¤±è´¥:`, err);
        }
      }
    });
  };

</script>


<style>
  /* å…¨å±€å®¹å™¨ */
  .page-container {
    flex: 1;
    /* å»æ‰åŸæ¥çš„çº¢è‰²èƒŒæ™¯ */
    /* background-color: #d93025; */ 
    display: flex;
    flex-direction: column;
    height: 100%;
    position: relative; /* ç¡®ä¿å­å…ƒç´ ç»å¯¹å®šä½ç›¸å¯¹äºæ­¤ */
  }

  /* --- æ–°å¢ï¼šèƒŒæ™¯è½®æ’­æ ·å¼ --- */
  .bg-swiper {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    z-index: 0; /* åœ¨æœ€åº•å±‚ */
  }
  .bg-image {
    width: 100%;
    height: 100%;
  }
  /* å¯é€‰ï¼šé®ç½©å±‚ï¼Œé˜²æ­¢èƒŒæ™¯å›¾å¤ªèŠ±å½±å“æ–‡å­—é˜…è¯» */
  .bg-mask {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.2); /* 20%ç™½è‰²é®ç½©ï¼Œå¯è‡ªè¡Œè°ƒæ•´é¢œè‰² */
    z-index: 1;
    pointer-events: none; /* è®©ç‚¹å‡»ç©¿é€é®ç½© */
  }

  .status-bar-placeholder {
    height: 44px;
    /* èƒŒæ™¯è®¾ä¸ºé€æ˜ï¼Œè®©è½®æ’­å›¾é€å‡ºæ¥ */
    background-color: transparent; 
    z-index: 2;
  }

  .main-scroll {
    flex: 1;
    z-index: 2; /* å†…å®¹å±‚çº§é«˜äºèƒŒæ™¯ */
  }

  /* --- é¡¶éƒ¨ Hero åŒºåŸŸ --- */
  .hero-section {
    height: 380px;
    /* ç§»é™¤åŸæ¥çš„æ¸å˜è‰²èƒŒæ™¯ */
    background-color: transparent; 
    padding: 10px 20px;
    position: relative;
    overflow: hidden;
  }

  /* (ä¿æŒåŸæœ‰çš„ hero å†…éƒ¨æ–‡å­—æ ·å¼ä¸å˜...) */
  .hero-text-group { margin-top: 10px; }
  .hero-title-row { flex-direction: row; align-items: flex-end; }
  .hero-big-num { font-size: 60px; font-weight: 900; color: #4a3b2a; line-height: 60px; }
  .hero-small-unit { font-size: 20px; color: #4a3b2a; margin-bottom: 10px; font-weight: bold; }
  .hero-sub-title { font-size: 24px; font-weight: bold; color: #4a3b2a; margin-top: -5px; }
  .hero-tag { background-color: #fff; border-radius: 4px; align-self: flex-start; padding: 2px 6px; margin-top: 5px; border-width: 1px; border-color: #4a3b2a; }
  .hero-tag-text { font-size: 10px; color: #4a3b2a; }
  .rotate-tag { position: absolute; top: 65px; left: 110px; background-color: #fff; border-width: 1px; border-color: #d4a770; padding: 2px 5px; transform: rotate(15deg); }
  .rotate-tag-text { font-size: 12px; color: #4a3b2a; font-weight: bold; }
  
  .center-slogan { position: absolute; top: 150px; left: 0; right: 0; align-items: center; transform: rotate(-10deg); }
  .slogan-text { font-size: 30px; font-weight: 900; color: #8c6a46; opacity: 0.2; }

  .float-packet { position: absolute; right: 10px; top: 180px; width: 70px; height: 70px; background-color: #f7d6a8; border-radius: 35px; justify-content: center; align-items: center; border-width: 2px; border-color: #fff; z-index: 5; }
  .packet-text { color: #d93025; font-weight: bold; font-size: 12px; }
  .packet-sub { color: #d93025; font-size: 10px; }

  /* --- ç™½è‰²æ ¸å¿ƒå¡ç‰‡ --- */
  .core-card {
    margin: -80px 15px 0 15px;
    background-color: #ffffff; /* ä¿æŒç™½è‰²èƒŒæ™¯ï¼Œä½¿å…¶åœ¨å¤æ‚çš„å›¾ç‰‡èƒŒæ™¯ä¸Šå¯è§ */
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 10;
  }

  /* (ä¿æŒåŸæœ‰çš„ core-card å†…éƒ¨æ ·å¼ä¸å˜...) */
  .user-row { flex-direction: row; justify-content: space-between; align-items: center; margin-bottom: 20px; }
  .user-left { flex-direction: row; align-items: center; }
  .avatar-circle { width: 30px; height: 30px; background-color: #eee; border-radius: 15px; justify-content: center; align-items: center; margin-right: 8px; }
  .user-name { font-size: 14px; font-weight: bold; color: #046b5a; }
  .user-right { flex-direction: row; align-items: center; }
  .user-stat { font-size: 11px; color: #046b5a; margin-left: 8px; }
  .user-stat.vip-badge { 
    background: linear-gradient(135deg, #f0c080, #d4a770);
    color: #fff;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
  }
  .qr-mini-icon { font-size: 16px; margin-left: 8px; color: #046b5a; }
  .big-actions { flex-direction: row; justify-content: space-between; margin-bottom: 20px; }
  .action-box { flex: 1; background-color: #fdf6e6; border-radius: 8px; padding: 10px; margin: 0 5px; height: 80px; justify-content: space-between; position: relative; }
  .action-sub { font-size: 11px; color: #997f5d; }
  .action-main { flex-direction: row; justify-content: space-between; align-items: flex-end; }
  .action-title { font-size: 24px; font-weight: bold; color: #333; font-family: serif; }
  .action-icon { font-size: 30px; }
  .badge-tag { position: absolute; top: 0; right: 0; background-color: #ff6b00; padding: 2px 4px; border-top-right-radius: 8px; border-bottom-left-radius: 8px; }
  .badge-text { color: #fff; font-size: 10px; }
  .sub-actions { flex-direction: row; justify-content: space-around; padding-top: 10px; }
  .sub-item { align-items: center; }
  .sub-icon-cloud { font-size: 24px; color: #e0e0e0; margin-bottom: 5px; }
  .sub-title { font-size: 14px; font-weight: bold; color: #333; }
  .sub-desc { font-size: 10px; color: #999; margin-top: 2px; }

  /* --- çº¢è‰²åŒºåŸŸ (ä¿®æ”¹ä¸ºé€æ˜) --- */
  .red-section {
    /* ç§»é™¤èƒŒæ™¯é¢œè‰²ï¼Œæ”¹ä¸ºé€æ˜ */
    background-color: transparent; 
    padding: 15px;
    padding-top: 20px;
  }

  /* (ä¿æŒåŸæœ‰çš„ red-section å†…éƒ¨æ ·å¼ä¸å˜...) */
  .banner-row { flex-direction: row; justify-content: space-between; margin-bottom: 15px; }
  .banner-item { flex: 1; height: 70px; border-radius: 8px; margin: 0 4px; padding: 10px; justify-content: center; overflow: hidden; }
  .black-gold { background-color: #2b2b2b; }
  .red-gold { background-color: #e64a45; border-width: 1px; border-color: #ffcccc; }
  .vip-text { color: #f0c080; font-size: 20px; font-style: italic; font-weight: bold; }
  .vip-sub { color: #f0c080; font-size: 10px; }
  .member-title { color: #fff; font-size: 16px; font-weight: bold; }
  .packet-text-sm { color: #d93025; font-size: 10px; font-weight: bold; }
  .packet-img-placeholder { align-self: flex-end; background-color: #fff; padding: 2px 5px; border-radius: 10px; margin-top: 5px; }
  .info-card { background-color: #ad8356; height: 100px; border-radius: 8px; margin-bottom: 10px; flex-direction: row; overflow: hidden; }
  .info-text-area { flex: 1; padding: 15px; justify-content: center; }
  .info-title { font-size: 20px; color: #fff; font-weight: bold; margin-bottom: 5px; text-shadow: 0 2px 2px rgba(0,0,0,0.2); }
  .info-sub { font-size: 12px; color: #eee; margin-bottom: 8px; }
  .info-btn { background-color: rgba(255,255,255,0.2); align-self: flex-start; padding: 2px 10px; border-radius: 12px; border-width: 1px; border-color: rgba(255,255,255,0.5); }
  .info-btn-text { color: #fff; font-size: 10px; }
  .info-img-area { width: 120px; justify-content: center; align-items: center; }
  .food-emoji { font-size: 60px; }
</style>